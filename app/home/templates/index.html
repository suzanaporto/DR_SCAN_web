{% extends "base_site.html" %}

{% block title %} Dashboard 1 {% endblock title %}

{% block stylesheets %}
  {{ super() }}
{% endblock stylesheets %}

{% block content %}
<style>
  .wizard_verticle ul.wizard_steps li a.selected:before, .step_no {
    background: #006938;
    color: #fff;
  }
  .wizard_horizontal ul.wizard_steps li a.selected:before, .step_no {
    background: #006938;
    color: #fff;
  }
  .wizard_horizontal ul.wizard_steps li a.done:before, .wizard_horizontal ul.wizard_steps li a.done .step_no {
    background: #5EC199;
    color: #fff;
  }
  .btn-primary {
    color: #fff;
    background-color: #006938;
    border-color: #005e32;
  }
  .btn-primary:hover {
    color: #fff;
    background-color: #00743e;
    border-color: #005e32;
  }
  .btn-success {
    background: #5EC199;
    border: 1px solid rgb(87, 177, 141);
  }

</style>
  <div class="right_col" role="main">
    <div class="">
      <div class="page-title">
        <div class="title_left">
          <!-- <h3>SNP SCANNER</h3> -->
        </div>

        <div class="title_right">
          <!-- <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search for...">
              <span class="input-group-btn">
                        <button class="btn btn-default" type="button">Go!</button>
              </span>
            </div>
          </div> -->
        </div>
      </div>
      <div class="clearfix"></div>

      <div class="row">

        <div class="col-md-12 col-sm-12 col-xs-12">
          <div class="x_panel">
            <div class="x_title">
              <h2>REGULOMIX </h2>
              <div class="clearfix"></div>
            </div>
            <div class="x_content">

              <!-- Smart Wizard -->
              <p>This step-by-step guide will give you instructions on how to put snps and analyze it.
                 Steps 2 and 5 are bound only by step1, step 4 is bound to steps 1 and 3, 
                 and step 3 is bound to step 1 and optionally by step 2.</p>
              <div id="wizard" class="form_wizard wizard_horizontal">
                <ul class="wizard_steps">
                  <li>
                    <a href="#step-1">
                      <span class="step_no">1</span>
                      <span class="step_descr">
                                        Step 1<br />
                                        <small>Insert Snps</small>
                      </span>
                    </a>
                  </li>
                  <li>
                    <a href="#step-2">
                      <span class="step_no">2</span>
                      <span class="step_descr">
                                        Step 2<br />
                                        <small>Cis-regulatory Elements</small>
                                    </span>
                    </a>
                  </li>
                  <li>
                    <a href="#step-3">
                      <span class="step_no">3</span>
                      <span class="step_descr">
                                        Step 3<br />
                                        <small>Generate Sequences</br>Upload TF Matrix</small>
                                    </span>
                    </a>
                  </li>
                  <li>
                    <a href="#step-4">
                      <span class="step_no">4</span>
                      <span class="step_descr">
                                        Step 4<br />
                                        <small>Differential TFs</small>
                                    </span>
                    </a>
                  </li>
                  <li>
                    <a href="#step-5">
                      <span class="step_no">5</span>
                      <span class="step_descr">
                                        Step 5<br />
                                        <small>Enhancer Promoter Interaction</small>
                                    </span>
                    </a>
                  </li>
                </ul>
                <div id="step-1">
                  <form class="form-horizontal form-label-left">

                    <!-- step 1 -->
                    <div class="col-md-12 col-sm-12 col-xs-12">
                      
                        <div class="x_title">
                          <h2 class="StepTitle"> Step 1 <small>Insert Snps </small></h2>
                          <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                          <p class="text-muted font-13 m-b-30">
                            First step is to insert snps id into its respective field. Click run to get snp information by its id. 
                            Or you can insert an .xlsx file with your SNPs, create one column named SNPS, and write down all SNPs IDs
                          </p>
                          
                          <div style="padding-bottom: 12px;">
                            <div style="display: inline-flex">
                              <form class='form-inline'>
                                <input type="text" class="form-control" style="margin-right: 10px" name="snp_input" id="snp_input"></input>
                                <button class="btn btn-success btn-xs submit" ><i class="fa fa-play"></i> Run </button>
                              </form>
                                <p style="margin-right: 30px;margin-left: 30px"> or </p>
                                <form class="form_inline" enctype="multipart/form-data" action="/uploader" method="POST" id="form_file">
                                  <div class="input-group">
                                    <div class="custom-file" style="display: inline-flex">
                                      <input type="file" class="custom-file-input" id="inputGroupFile01" name="file" aria-describedby="inputGroupFileAddon01"></input>
                                      <button type="submit" class="btn btn-success btn-xs submit_file" id="submit_file" onclick="$('.load').show();"><i class="fa fa-play"></i> Run </button>
                                      <div class="load" style="display:inline-block"> <i class="fa fa-cog fa-spin fa-5x fa-fw"style="font-size: 25px;"></i> </div>
                                      <span class="load">Processing...</span>
                                    </div>
                                  </div>
                                </form>
                              
                            </div>
                            
                          </div>
                          <table id="datatable-buttons" class="table table-striped table-bordered">
                            <thead>
                              <tr>
                                <th>Snp Name</th>
                                <th>Location</th>
                                <th>Chromossome</th>
                                <th>Allele Wild Type</th>
                                <th>Allele Variation</th>
                                <th>Row Actions</th>
                              </tr>
                            </thead>
                            <tbody id="t-body">
                            </tbody>
                          </table>
                        </div>
                        <div>
                            
                      </div>
                      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                      <script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
                      <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
                      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
                      <script>
                        //hide loading image
                        $(document).ready(function() {
                          $('.load').hide();
                        });

                        //Save when step changes
                        $(document).ready(function(){
                          $('#wizard').smartWizard({
                            onLeaveStep:leaveAStepCallback,
                          });
                          function leaveAStepCallback(obj, context){
                            var user_id = '{{ current_user.id }}';
                            //get variables leaving step 1
                            if (context.fromStep == 1){
                              var table_one = $('#datatable-buttons').DataTable();
                              var data = table_one.rows().data();
                              var rows2 = table_one.rows().data().length;
                              var row_list = []
                              for(i=0;i<rows2;i++){
                                row_list.push(table_one.rows().data()[i])
                              };
                            }
                            //get variables leaving step 2
                            if (context.fromStep == 2){
                              var table_one = $('#datatable-buttons').DataTable();
                              var data = table_one.rows().data();
                              var rows2 = table_one.rows().data().length;
                              var row_list = []
                              for(i=0;i<rows2;i++){
                                row_list.push(table_one.rows().data()[i])
                              };
                              var table_two = $('#datatable-buttons-x').DataTable();
                              var data = table_two.rows().data();
                              var rows = table_two.rows().data().length;
                              var row_list1 = []
                              for(i=0;i<rows;i++){
                                row_list1.push(table_two.rows().data()[i])
                              };
                            }
                            //save both steps 1 and 2
                            if (context.fromStep < 3 && context.fromStep < context.toStep){
                              if (context.fromStep == 1){
                                $.ajax({
                                  url: '/home/next_step'+ context.fromStep,
                                  type: 'POST',
                                  data: { 
                                    step: context.fromStep,
                                    user: user_id,
                                    data: JSON.stringify(row_list),
                                  },
                                  async: false,
                                  success:function(response) {
                                    console.log(response)
                                  },error: function(){
                                    console.log('error---')
                                  }
                                });
                              }else{
                                if (context.fromStep == 2){
                                  console.log(row_list);
                                  $.ajax({
                                    url: '/home/next_step'+ context.fromStep,
                                    type: 'POST',
                                    data: { 
                                      step: context.fromStep,
                                      user: user_id,
                                      //add table 2 in data to commit 1 and 2
                                      data: JSON.stringify(row_list),
                                      data2: JSON.stringify(row_list1),
                                    },
                                    async: false,
                                    success:function(response) {
                                      console.log(response)
                                    },error: function(){
                                      console.log('error---')
                                    }
                                  });
                                }
                              }
                            }
                            return true; // return false to stay on step and true to continue navigation 
                          }
                        });
                        $(document).ready(function() {
                          //get user id
                          var user_id = '{{ current_user.id }}';
                          //delete_old_files
                          $.ajax({
                              url: '/home/delete_old',
                              type: 'POST',
                              success:function(response) {
                                console.log(response)
                              }
                          });
                          //retrive first first
                          $.ajax({
                            url: '/home/data_retrive',
                            type: 'POST',
                            data: { data_user: user_id },
                            success:function(response) {
                              if (response != 'No File'){
                                var t = $('#datatable-buttons').DataTable();
                                // if (response['CHROM'] != null){
                                //   var size = Object.keys(response['CHROM']).length;
                                // }
                                if (response[0][0].includes("rs")){
                                  //different method for retrieving
                                  for(i=0;i<response.length;i++){
                                    t.row.add( [
                                      response[i][0],
                                      response[i][1],
                                      response[i][2],
                                      response[i][3],
                                      response[i][4],
                                      '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                      '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                    ] );
                                  }
                                  t.draw();
                                }else{
                                  for(i=0;i<response.length;i++){
                                    t.row.add( [
                                      response[i][1],
                                      response[i][0][0].location,
                                      response[i][0][0].chrom,
                                      response[i][0][0].allele_wt,
                                      response[i][2],
                                      '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                      '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                    ] );
                                  }
                                  t.draw();
                                }
                              }
                            },
                            error:function(result){
                              console.log("No file found")
                            }
                          });
                          $.ajax({
                            url: '/home/data_retrive1',
                            type: 'POST',
                            data: { data_user: user_id },
                            success:function(response) {
                              if (response != 'No File'){
                                var table_2 = $('#datatable-buttons-x').DataTable();
                                var x_boolean = true;
                                //different method for retrieving
                                if (response[0]['reg_elemnt']){
                                  console.log('TRUE -- reg_elemnt tag')
                                  for (let i = 0; i < response.length; i++) {
                                    if (response[i]['reg_elemnt'].split("|")[0] != "DO NOT EXIST "){
                                      table_2.row.add( [
                                        response[i]['snp_name'],
                                        response[i]['state_model'],
                                        response[i]['tissue'],
                                        response[i]['reg_elemnt'],
                                      ] );
                                      table_2.draw();
                                    }else{
                                      if (x_boolean){
                                        alert("One of the tissues does not exist")
                                        x_boolean = false
                                      }
                                    }
                                  }
                                }else{
                                  // When commit is done
                                  console.log('HERE --- debugging new list')
                                  console.log(response[0])
                                  console.log(response[1])
                                  for (let i = 0; i < response.length; i++) {
                                    if (response[i][3].split("|")[0] != "DO NOT EXIST "){
                                      table_2.row.add( [
                                        response[i][0],
                                        response[i][1],
                                        response[i][2],
                                        response[i][3],
                                      ] );
                                      table_2.draw();
                                    }else{
                                      if (x_boolean){
                                        alert("One of the tissues does not exist")
                                        x_boolean = false
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            error:function(result){
                                console.log("No file found")
                            }
                          });
                            $.ajax({
                              url: '/home/data_retrive2',
                              type: 'POST',
                              data: { data_user: user_id },
                              success:function(response) {
                                if (response != 'No File'){
                                  //implement the data retrieve for step 3
                                  uploaded = 0
                                  //reset disable
                                  $('#tfs').removeAttr('disabled');
                                  //insert alleles dictionary in variable
                                  allele_dict = response[1]
                                  //insert text into 'p' element
                                  for(i=0;i<response[0][0].length;i++){
                                    $('#sequences').append( document.createTextNode( response[0][0][i]) );
                                    $('#sequences').append( document.createElement( "br") );
                                  }
                                }
                              },
                              error:function(result){
                                console.log("No file found")
                              }
                            });
                            $.ajax({
                              url: '/home/data_retrive3',
                              type: 'POST',
                              data: { data_user: user_id },
                              success:function(response) {
                                if (response != 'No File'){
                                  // step 4 retrieve
                                  var t = $('#datatable-buttons-ft').DataTable();
                                  //iterate through response to add rows in the table
                                  for(i=0;i<response.length;i++){
                                    t.row.add( [
                                      response[i]['motif_id'],
                                      response[i]['motif_alt_id'],
                                      response[i]['sequence_name'],
                                      response[i]['strand'],
                                      response[i]['start'],
                                      response[i]['stop'],
                                      response[i]['p-value'],
                                      response[i]['q-value'],
                                      response[i]['matched_sequence'],
                                    ] );
                                  }; 
                                  t.draw(); 
                                }
                              },
                              error:function(result){
                                console.log("No file found")
                              }
                            });
                            $.ajax({
                              url: '/home/data_retrive4',
                              type: 'POST',
                              data: { data_user: user_id },
                              success:function(response) {
                                if (response != 'No File'){
                                  // step 5 retrieve
                                  //declare datatable
                                  var t = $('#datatable-buttons-epi').DataTable();
                                  //iterate through response to add rows in the table
                                  if( response == undefined ) {
                                    console.log("EMPTY")
                                  } else {
                                    for(i=0;i<response.length;i++){
                                      t.row.add( [
                                        response[i]['SNP'],
                                        response[i]['Location'],
                                        response[i]['Gene ID'],
                                        response[i]['Gene'],
                                        response[i]['Gene Location'],
                                        response[i]['Score'],
                                        response[i]['Tissue'],
                                        response[i]['File_Type'],
                                      ] )
                                    };
                                    t.draw();  
                                  }
                                }
                              },
                              error:function(result){
                                console.log("No file found")
                              }
                            });
                        });
                     </script>
                      <script type=text/javascript>
                        $(function() {
                          $('#form_file').on("submit", function() {
                            // event.preventDefault()
                            //send file excel file
                            var formData = new FormData(this);
                            formData.append('user_id', {{current_user.id}});
                            formData.append('user_email', "{{current_user.email}}");
                            
                            var table_delete_all = $('#datatable-buttons').DataTable();
                            table_delete_all.clear().draw();
                            //clear all steps
                            var table_delete = $('#datatable-buttons-x').DataTable();
                            table_delete.clear().draw();
                            var table_delete1 = $('#datatable-buttons-ft').DataTable();
                            table_delete1.clear().draw();
                            var table_delete2 = $('#datatable-buttons-epi').DataTable();
                            table_delete2.clear().draw();
                            //delete text and dictionary variable
                            allele_dict = undefined
                            var element;
                            element = document.getElementById("sequences");
                            if (element) {
                              element.innerHTML = "";
                            }
                            if ($('input[type="file"]').val().trim() == false){
                              alert("Insert .xlxs file with SNP ids in rows")
                              $('.load').hide();
                              return false;
                            }
                            $.ajax({
                              url: '/home/uploader',
                              type: 'POST',
                              data: formData,
                              success:function(response) {
                                if (response.status == 202) {
                                  var intervalo_nome = setInterval(  function(){
                                    //get user id
                                    var user_id = '{{ current_user.id }}';
                                    $.ajax({
                                      url: '/home/data_retrive_thread',
                                      type: 'POST',
                                      data: { 
                                            data_user: user_id 
                                      },
                                      success:function(response) {    
                                      if (response != 'No File' && response != 'Thread Error'){
                                        $('.load').hide();
                                        clearInterval(intervalo_nome);
                                        var t = $('#datatable-buttons').DataTable();
                                        // if (response['CHROM'] != null){
                                        //   var size = Object.keys(response['CHROM']).length;
                                        // }
                                        // response["ID"]!= undefined
                                        if (response[0][0].includes("rs")){
                                          //different method for retrieving
                                          for(i=0;i<response.length;i++){
                                            t.row.add( [
                                              response[i][0],
                                              response[i][1],
                                              response[i][2],
                                              response[i][3],
                                              response[i][4],
                                              '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                              '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                            ] );
                                          }
                                          t.draw();
                                        }else{
                                          for(i=0;i<response.length;i++){
                                            t.row.add( [
                                              response[i][1],
                                              response[i][0][0].location,
                                              response[i][0][0].chrom,
                                              response[i][0][0].allele_wt,
                                              response[i][2],
                                              '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                              '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                            ] );
                                          }
                                          t.draw();
                                        }
                                      }else{
                                        if (response == 'No File') {
                                          console.log("Aguardando")
                                        }else{
                                          if (response == 'Thread Error') {
                                            $('.load').hide();
                                            clearInterval(intervalo_nome);
                                            alert('Error processing try again, or verify SNPS data')
                                          }
                                        }
                                      }
                                    },
                                    error:function(result){
                                      console.log("No file found")
                                      $('.load').hide();
                                    },
                                    
                                  });
                                 }, 
                                 20000);
                                }

                                //hide gif after success
                                // $('.load').hide();
                                // console.log("Success form")
                                // console.log(response)
                                // var t = $('#datatable-buttons').DataTable();
                                // for(i=0;i<response.length;i++){
                                //     t.row.add( [
                                //       response[i][1],
                                //       response[i][0][0].location,
                                //       response[i][0][0].chrom,
                                //       response[i][0][0].allele_wt,
                                //       response[i][2],
                                //       '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                //       '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                //     ] );
                                // }
                                // t.draw();
                                // //delete all the tables and data from other steps
                                // var table_delete = $('#datatable-buttons-x').DataTable();
                                // table_delete.clear().draw();
                                // var table_delete1 = $('#datatable-buttons-ft').DataTable();
                                // table_delete1.clear().draw();
                                // var table_delete2 = $('#datatable-buttons-epi').DataTable();
                                // table_delete2.clear().draw();
                                // //delete text and dictionary variable
                                // allele_dict = undefined
                                // var element;
                                // element = document.getElementById("sequences");
                                // if (element) {
                                //   element.innerHTML = "";
                                // }
                              },error:function(){
                                  alert("SNP not found. Try to verify if each snp is corrected in your file")
                                  // $('.load').hide();
                                },
                              cache: false,
                              contentType: false,
                              processData: false
                              });
                              return false;
                            });
                          });
                        </script>
                        <script>
                          //javascript function
                          function verify(response) {
                            
                            //pass
                            if (response.status == 202) {
                              console.log("Aguardando...")
                            }else{
                              if(response.status != 202) {
                                
                                //hide gif after success
                                // $('.load').hide();
                                // console.log("Success form")
                                // console.log(response)
                                // var t = $('#datatable-buttons').DataTable();
                                // for(i=0;i<response.length;i++){
                                //     t.row.add( [
                                //       response[i][1],
                                //       response[i][0][0].location,
                                //       response[i][0][0].chrom,
                                //       response[i][0][0].allele_wt,
                                //       response[i][2],
                                //       '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                //       '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                //     ] );
                                // }
                                // t.draw();
                                // //delete all the tables and data from other steps
                                // var table_delete = $('#datatable-buttons-x').DataTable();
                                // table_delete.clear().draw();
                                // var table_delete1 = $('#datatable-buttons-ft').DataTable();
                                // table_delete1.clear().draw();
                                // var table_delete2 = $('#datatable-buttons-epi').DataTable();
                                // table_delete2.clear().draw();
                                // //delete text and dictionary variable
                                // allele_dict = undefined
                                // var element;
                                // element = document.getElementById("sequences");
                                // if (element) {
                                //   element.innerHTML = "";
                                // }
                              }
                            }
                          }
                        </script>
                        <script type=text/javascript>
                          $(function() {
                            $('.btn.btn-success.btn-xs.submit').bind('click', function() {
                              event.preventDefault()
                              var snp = $('#snp_input').val();
                              if (snp.substring(0,2) !== "rs"){
                                alert("Insert 'rs' and number (e.g. rs21231)")
                                return false
                              }
                              $.ajax({
                                url: '/home/get_snp_info',
                                data: {
                                  snp_name: snp
                                },
                                type: 'POST',
                                dataType: 'json',
                                success:function(response) {
                                  //if SNP couldnt be found send alert to user
                                  var t = $('#datatable-buttons').DataTable();
                                    t.row.add( [
                                      response[1],
                                      response[0][0].location,
                                      response[0][0].chrom,
                                      response[0][0].allele_wt,
                                      response[2],
                                      '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-pencil"></i> Edit </a>'+
                                      '<a href="#" class="btn btn-danger btn-xs" ><i class="fa fa-trash-o"></i> Delete </a>',
                                    ] ).draw();
                                  
                                },error: function(){
                                  alert("SNP not found")
                                }
                                
                              });
                            });
                          });
                        </script>
                        <!-- <script>
                          $(function() {
                            $('.buttonNext.btn.btn-success').bind('click', function() {
                              console.log('BUTTON CLICKED');
                            });
                          });
                        </script>
                -->
                            <script type="text/javascript">
                              //JQuery to delete rows.Working and using the datatables API
                              $(document).ready(function() {
                                
                                $('#datatable-buttons tbody').on( 'click', '.btn.btn-danger.btn-xs', function () {
                                  event.preventDefault();
                                  var table_edit = $('#datatable-buttons').DataTable();
                                  table_edit
                                    .row( $(this).parents('tr') )
                                    .remove()
                                    .draw(false);
                                });
                              });
                            </script>
                            <script>
                            //JQuery for editing datatable
                            //working
                            //transform cells into editable text fields
                            $(document).ready(function(){

                              $('#datatable-buttons').on( 'click.edit', '.btn.btn-info.btn-xs.edit', function () {
                                event.preventDefault()
                                //table
                                var myTable = $('#datatable-buttons').DataTable();
                                //change edit icon and text inside a href from edit to save
                                $(this).children('i').removeClass("fa fa-pencil").addClass("fa fa-check");
                                $(this).removeClass("edit").addClass("save");
                                this.childNodes[1].nodeValue = "Save"
                                //get row and change all of them to input type text and put its value as their text
                                var $row = $(this).closest("tr")
                                var $tds = $row.find("td").not(':first').not(':last');

                                //add selected class
                                $row.addClass('selected');
                                $.each($tds, function(i, el) {
                                  //testing function
                                  var txt = $(this).text();
                                  $(this).html("").append("<input type='text' value=\""+txt+"\">");
                                });
                              } );

                              //stop propagation input
                              $("#datatable-buttons").on('click', "input", function(e) {
                                e.stopPropagation();
                              });
                              
                              //save button
                              $("#datatable-buttons").on('click.save', ".btn.btn-info.btn-xs.save", function(e) {
                                e.preventDefault()
                                $(this).children('i').removeClass("fa fa-check").addClass("fa fa-pencil");
                                $(this).removeClass("save").addClass("edit");
                                this.childNodes[1].nodeValue = " Edit "
                                var $row = $(this).closest("tr");
                                var row_idx = $row.index();
                                var $tds = $row.find("td").not(':first').not(':last');

                                var key_name = $row.find("td:first").text();
                                console.log(key_name);

                                $.each($tds, function(i, el) {
                                  var txt = $(this).find('input:text').val();
                                  var td_index = $(this).index();
                                  //remove select class
                                  $row.removeClass('selected');
                                  // $(this).html(txt);
                                  // $("#datatable-buttons").DataTable().cell(row_idx,td_index).data(txt).draw(false);
                                  var rowData = $("#datatable-buttons").DataTable().row( $row ).data();
                                  rowData[td_index] = txt;
                                  $(this).html(txt);
                                  // $(this).html(txt);
                                });
                                
                                //update data table
                              });
                            });
                            </script>
                    </div>
                  </form>

                </div>
                
                <div id="step-2">
                    <!-- step 2 -->
                    <div class="col-md-12 col-sm-12 col-xs-12">
                      
                        <div class="x_title">
                          <h2 class="StepTitle"> Step 2 <small>Verify Cis-Regulatory Elements </small></h2>
                          <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                          <p class="text-muted font-13 m-b-30">
                            Second step verify if the snps are in a cis-regulatory element. See <a href="/home/index2" target="_blank">ID Catalogue</a> to insert in field. To enter more than one tissue, write | between them.
                          </p>
                          <div>
                            <form class="form-inline">
                                <input type="text" name="tissue_field" id="tissue_field" class="form-control"></input>
                                <a href="#" class="btn btn-success btn-xs verify" onclick="$('.load2').show();"><i class="fa fa-play"></i> Run </a>
                                <div class="load2" style="display:inline-block"> <i class="fa fa-cog fa-spin fa-5x fa-fw"style="font-size: 25px;"></i> </div>
                                <span class="load2">Processing...</span>
                            </form>
                            
                          </div>
                          
                          <table id="datatable-buttons-x" class="table table-striped table-bordered">
                            <thead>
                              <tr>
                                <th>Snp Name</th>
                                <th>State Model</th>
                                <th >Tissue</th>
                                <th>Regulatory Element</th>
                                <!-- <th>Row Action</th> -->
                              </tr>
                            </thead>
                            <!--Style Datatables-buttons-x to add margin-->
                            <style>
                              #datatable-buttons-x_wrapper {
                                margin-top: 10px;
                              }
                            </style>
                            <tbody id="t-body">
                              
                            </tbody>
                          </table>
                        
                          <!-- Delete snps from all tables option -->
                          <div style="margin-top:60px;padding-top:10px">
                            <!--Step 2.1 title-->
                            <h2 class=""> Step 2.1 <small>Delete SNPs from Tables </small></h2>
                              <!--Explanation-->
                              <p class="text-muted font-13 m-b-30">
                                Delete SNPs if you dont want to analyze them for third and fourth steps
                              </p>
                            <!--Delete snps form/ Delete from step 1 and step 2-->
                            <form class="form-inline">
                                <!--Text fiel to insert snp ids-->
                                <input type="text" name="delete_snp" id="delete_snp" class="form-control"></input>
                                <!--Button to delete snps-->
                                <a href="#" class="btn btn-danger btn-xs delete_snps"><i class="fa fa-trash-o"></i> Delete </a>
                            </form>

                            <div class="checkboxes conteiner" style = "margin-top: 20px;">
                              <form>
                                <p class="text-muted font-13 m-b-30">
                                  Choose regulatory element you want to keep snps from. The rest is going to be deleted.
                                </p>
                                <label  style="display: flexbox">Select Tissue</label>
                                  <div style= "display: inline-flex">
                                    <select class="form-control" id="tissues_option">
                                      <option>E001</option>
                                      <option>E002</option>
                                      <option>E003</option>
                                      <option>E004</option>
                                      <option>E005</option>
                                      <option>E006</option>
                                      <option>E007</option>
                                      <option>E008</option>
                                      <option>E009</option>
                                      <option>E010</option>
                                      <option>E011</option>
                                      <option>E012</option>
                                      <option>E013</option>
                                      <option>E014</option>
                                      <option>E015</option>
                                      <option>E016</option>
                                      <option>E017</option>
                                      <option>E018</option>
                                      <option>E019</option>
                                      <option>E020</option>
                                      <option>E021</option>
                                      <option>E022</option>
                                      <option>E023</option>
                                      <option>E024</option>
                                      <option>E025</option>
                                      <option>E026</option>
                                      <option>E027</option>
                                      <option>E028</option>
                                      <option>E029</option>
                                      <option>E030</option>
                                      <option>E031</option>
                                      <option>E032</option>
                                      <option>E033</option>
                                      <option>E034</option>
                                      <option>E035</option>
                                      <option>E036</option>
                                      <option>E037</option>
                                      <option>E038</option>
                                      <option>E039</option>
                                      <option>E040</option>
                                      <option>E041</option>
                                      <option>E042</option>
                                      <option>E043</option>
                                      <option>E044</option>
                                      <option>E045</option>
                                      <option>E046</option>
                                      <option>E047</option>
                                      <option>E048</option>
                                      <option>E049</option>
                                      <option>E050</option>
                                      <option>E051</option>
                                      <option>E052</option>
                                      <option>E053</option>
                                      <option>E054</option>
                                      <option>E055</option>
                                      <option>E056</option>
                                      <option>E057</option>
                                      <option>E058</option>
                                      <option>E059</option>
                                      <option>E060</option>
                                      <option>E061</option>
                                      <option>E062</option>
                                      <option>E063</option>
                                      <option>E065</option>
                                      <option>E066</option>
                                      <option>E067</option>
                                      <option>E068</option>
                                      <option>E069</option>
                                      <option>E070</option>
                                      <option>E071</option>
                                      <option>E072</option>
                                      <option>E073</option>
                                      <option>E074</option>
                                      <option>E075</option>
                                      <option>E076</option>
                                      <option>E077</option>
                                      <option>E078</option>
                                      <option>E079</option>
                                      <option>E080</option>
                                      <option>E081</option>
                                      <option>E082</option>
                                      <option>E083</option>
                                      <option>E084</option>
                                      <option>E085</option>
                                      <option>E086</option>
                                      <option>E087</option>
                                      <option>E088</option>
                                      <option>E089</option>
                                      <option>E090</option>
                                      <option>E091</option>
                                      <option>E092</option>
                                      <option>E093</option>
                                      <option>E094</option>
                                      <option>E095</option>
                                      <option>E096</option>
                                      <option>E097</option>
                                      <option>E098</option>
                                      <option>E099</option>
                                      <option>E100</option>
                                      <option>E101</option>
                                      <option>E102</option>
                                      <option>E103</option>
                                      <option>E104</option>
                                      <option>E105</option>
                                      <option>E106</option>
                                      <option>E107</option>
                                      <option>E108</option>
                                      <option>E109</option>
                                      <option>E110</option>
                                      <option>E111</option>
                                      <option>E112</option>
                                      <option>E113</option>
                                      <option>E114</option>
                                      <option>E115</option>
                                      <option>E116</option>
                                      <option>E117</option>
                                      <option>E118</option>
                                      <option>E119</option>
                                      <option>E120</option>
                                      <option>E121</option>
                                      <option>E122</option>
                                      <option>E123</option>
                                      <option>E124</option>
                                      <option>E125</option>
                                      <option>E126</option>
                                      <option>E127</option>
                                      <option>E128</option>
                                      <option>E129</option>
                                    </select>
                                  </div>
                                <div style="display: flexbox">
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                      Active TSS
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                        <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                        
                                      
                                      Promoter Upstream TSS
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                    Promoter Downstream TSS with DNase
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      

                                    Promoter Downstream TSS
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                    Transcription 5'
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                 
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                      
                 
                                    Transcription
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                 
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                   
                                    Transcription 3'
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
              
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
            
                                    Weak transcription
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
        
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                   
                                    Transcription regulatory
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
               
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                           
                                    Transcription 5' Enhancer
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     

                                    Transcription 3' Enhancer
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                   
                                    Transcription Weak Enhancer
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      

                                    Active Enhancer 1
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>

                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
               
                                    Active Enhancer 2
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                 
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                   
                                    Active Enhancer Flank
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                         
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                          
                                    Weak Enhancer 1
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
        
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                              
                                    Weak Enhancer 2
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                  
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                  
                                   
                                    Enhancer Acetylation Only
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                           
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                   
                                    DNase only
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                               
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                              
                                    
                                    ZNF genes & repeats
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                    
                                   
                                    Heterochromatin
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                 
                                    
                                    Poised Promoter
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                                    
                                    Bivalent Promoter
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                    Repressed PolyComb
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                    Quiescent/Low
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">

                                    
                                    Flanking TSS
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">

                                    
                                    Flanking TSS Upstream
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                    Flanking TSS Downstream
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                    Strong Transcription
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    
                                   Genic Enhancer 1
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    Genic Enhancer 2
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                                    
                                    Weak Enhancer
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                                    Bivalent/Poised TSS
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                                    Bivalent Enhancer
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    Weak Repressed PolyComb
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                     
                                    Flanking Active TSS
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    Transcr. at gene 5' and 3'
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                    
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    Genic enhancers
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    Enhancers
                                  </label>
                                </div>
                                <div class="checkbox col-sm-3 col-md-6">
                                  <label class>
                                      <input type="checkbox" class="flat" style="position: absolute; opacity: 0;">
                                      
                                    Flanking Bivalent TSS/Enh
                                  </label>
                                </div>
                              </div>
                              </form>
                              <button type="submit" class="btn btn-success submit delete_s">Submit</button>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                <script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
                <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
                <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

                <!--hide loading image-->
                <script>
                  $(document).ready(function() {
                    $('.load2').hide();
                  });
                </script>
                <!--Verify Regulatory elements button (Step 2 Button)-->
                <script type="text/javascript">
                  $(document).ready(function() {
                    $('#datatable-buttons-x').DataTable( {
                      dom: 'Bfrtip',
                      buttons: {
                        buttons: [
                          { extend: 'copy', className: 'btn-sm' },
                          { extend: 'csv', className: 'btn-sm' },
                          { extend: 'print', className: 'btn-sm' }
                        ]
                      }
                    } );
                  } );
                  $(function() {
                    //Getting information from snp_datatable first step
                    //When run button is clicked in the second step
                    $('.btn.btn-success.btn-xs.verify').bind('click', function() {
                      //important method so that the ajax doesn't refresh the page
                      event.preventDefault()

                      //table from step 1
                      var table = $('#datatable-buttons').DataTable();
                      //table from step 2
                      var table_re = $('#datatable-buttons-x').DataTable();

                      //get snp info from step 1
                      var rows2 = table.rows().data().length;
                      var row_list = []
                      for(i=0;i<rows2;i++){
                        row_list.push(table.rows().data()[i])
                      };
                      var tissue = $('#tissue_field').val();
                      
                      //delete data from table 2
                      table_re.rows().remove().draw();

                      var user_id = '{{ current_user.id}}';
                      $.ajax({

                        url: '/home/verify_snps',
                        type: 'POST',
                        dataType: 'json',
                        data: { snp_list:JSON.stringify(row_list), 
                              tissue_field: tissue,
                              user_id : user_id,
                              user_email : '{{current_user.email}}'
                        },
                        // async: false,
                        success:function(response) {

                          if(response.status == 202){
                            var intervalo2_nome = setInterval(function(){
                              // Ajax to keep findind the file
                              // get user id
                              var user_id = '{{ current_user.id }}'
                              $.ajax({
                                url: '/home/data_retrive2_thread',
                                type: 'POST',
                                data: { 
                                  data_user: user_id 
                                },
                                success:function(response){
                                  if(response != 'No File' && response != 'Thread Error'){
                                    $('.load2').hide();
                                    clearInterval(intervalo2_nome);
                                    if (response != 'No File'){
                                        var table_2 = $('#datatable-buttons-x').DataTable();
                                        var x_boolean = true;
                                        //different method for retrieving
                                        if (response[0]['reg_elemnt']){
                                          console.log('TRUE -- reg_elemnt tag')
                                          for (let i = 0; i < response.length; i++) {
                                            if (response[i]['reg_elemnt'].split("|")[0] != "DO NOT EXIST "){
                                              table_2.row.add( [
                                                response[i]['snp_name'],
                                                response[i]['state_model'],
                                                response[i]['tissue'],
                                                response[i]['reg_elemnt'],
                                              ] );
                                              table_2.draw();
                                            }else{
                                              if (x_boolean){
                                                alert("One of the tissues does not exist")
                                                x_boolean = false
                                              }
                                            }
                                          }
                                        }else{
                                          // When commit is done
                                          console.log('HERE --- debugging new list')
                                          console.log(response[0])
                                          console.log(response[1])
                                          for (let i = 0; i < response.length; i++) {
                                            if (response[i][3].split("|")[0] != "DO NOT EXIST "){
                                              table_2.row.add( [
                                                response[i][0],
                                                response[i][1],
                                                response[i][2],
                                                response[i][3],
                                              ] );
                                              table_2.draw();
                                            }else{
                                              if (x_boolean){
                                                alert("One of the tissues does not exist")
                                                x_boolean = false
                                              }
                                            }
                                          }
                                        }
                                        //Delete from other steps
                                        var table_delete1 = $('#datatable-buttons-ft').DataTable();
                                        table_delete1.clear().draw();
                                        var table_delete2 = $('#datatable-buttons-epi').DataTable();
                                        table_delete2.clear().draw();
                                        //delete text and dictionary variable
                                        allele_dict = undefined
                                        var element;
                                        element = document.getElementById("sequences");
                                        if (element) {
                                          element.innerHTML = "";
                                        }
                                      }
                                  }else{
                                    if(response == 'No File'){
                                      console.log("Aguardando")
                                    }else{
                                      if(response == 'Thread Error') {
                                        $('.load2').hide();
                                        clearInterval(intervalo2_nome);
                                        alert('Error in verify thread, check SNPs or try again')
                                      }
                                    }
                                  }
                                },
                                error: function (result){
                                  console.log("No file found");
                                  $('.load2').hide();
                                }
                              });
                            }, 20000);
                          }
                          // //hide load button
                          // $('.load2').hide();
                          // //some debbugging
                          // if (response[0] == undefined){
                          //     alert("Insert snp first")
                          // }else{
                          //   console.log("LOG: " + response[0]['state_model'])
                          //   //declare datatable
                          //   var t = $('#datatable-buttons-x').DataTable();
                          //   //iterate through response to add rows in the table
                          //   var x_boolean = true
                          //   for(i=0;i<response.length;i++){
                          //     if (response[i]['reg_elemnt'].split("|")[0] != "DO NOT EXIST "){
                          //       t.row.add( [
                          //         response[i]['snp_name'],
                          //         response[i]['state_model'],
                          //         response[i]['tissue'],
                          //         response[i]['reg_elemnt'],
                          //       ] );
                          //       t.draw();
                          //     }else{
                          //       if (x_boolean){
                          //         alert("One of the tissues does not exist")
                          //         x_boolean = false
                          //       }
                          //     }
                          //   };
                          // }
                          // //delete all the tables and data from other steps
                          // var table_delete1 = $('#datatable-buttons-ft').DataTable();
                          // table_delete1.clear().draw();
                          // var table_delete2 = $('#datatable-buttons-epi').DataTable();
                          // table_delete2.clear().draw();
                          // //delete text and dictionary variable
                          // allele_dict = undefined
                          // var element;
                          // element = document.getElementById("sequences");
                          // if (element) {
                          //   element.innerHTML = "";
                          // }
                        }
                      });
                    });
                  });
                </script>
                  <!-- STEP 2.5 Delete snps button function -->
                  <script type="text/javascript">
                    //STEP 2.5 delete snps logic
                    $(function() {
                      //Getting information from snp_datatable first step
                      //When run button is clicked in the second step
                      $('.btn.btn-danger.btn-xs.delete_snps').bind('click', function() {
                        //important method so that the ajax doesn't refresh the page
                        event.preventDefault()
                        //get snps from text field
                        var snps = document.getElementById("delete_snp").value;
                        console.log(snps);
                        //split string
                        var snps_del_array = snps.split(",");

                        var table_snp = $('#datatable-buttons').DataTable();
                        var table_reg = $('#datatable-buttons-x').DataTable();

                        var rows = table_snp.rows().data();
                        var rows2 = table_reg.rows().data();
                        var row_idx_del = [];
                        var row2_idx_del = [];
                        console.log("INDEXES 1:"+row_idx_del);
                        //loop and remove tr from table 1
                        var snp_exist = false

                        for(j=0;j<snps_del_array.length;j++){
                        
                          table_snp.rows().nodes().each(function(a,b) {
                            if($(a).children().eq(0).text() == snps_del_array[j].trimLeft()){
                              table_snp.rows(a).remove();
                              snp_exist = true
                            }
                          });
                        }
                        table_snp.rows().invalidate();
                        table_snp.draw();

                        for(j=0;j<snps_del_array.length;j++){
                        
                          table_reg.rows().nodes().each(function(a,b) {
                          if($(a).children().eq(0).text() == snps_del_array[j].trimLeft()){
                            table_reg.rows(a).remove();
                            snp_exist = true
                          }
                        });
                      }
                      table_reg.rows().invalidate();
                      table_reg.draw();
                      if(snp_exist == false){
                        alert("This snp doesnt exist!")
                      }
                      });
                    });
                  </script>
                  <!-- STEP 2.1 Delete snps button function -->
                  <script type="text/javascript">
                    //TODO delete snps
                    $(function() {
                      $('.btn.btn-success.submit.delete_s').bind('click', function() {
                        event.preventDefault()
                        //get value of tissue
                        var tissue_chosen = $("#tissues_option").val();
                        console.log("TISSUE_CHOSEN: "+tissue_chosen)
                        //get value of checked labels
                        var checked_labels = [];

                        console.log("QUANTAS TEM CHECADA")
                        console.log($(':checkbox:checked').length)
                        for (let index = 0; index <$(':checkbox:checked').length; index++) {
                          var element = $(':checkbox:checked')[index].parentNode.parentNode.textContent;
                          console.log(element.trim());
                          checked_labels.push(element.trim())
                        }
                        //setting table variables
                        var table_snp = $('#datatable-buttons').DataTable();
                        var table_reg = $('#datatable-buttons-x').DataTable();

                        var rows = table_snp.rows().data();
                        var rows2 = table_reg.rows().data();
                        var row_idx_del = [];
                        var row2_idx_del = [];
                        var snps_del_list = [];
                        //loop thru data in table and delete if its not in checked labels
                        //delete from table step two
                        var founded = false;
                          table_reg.rows().nodes().each(function(a,b) {
                            //check if row had the tissue chosen by user
                            if($(a).children().eq(2).text() == tissue_chosen){
                              //get regulatory element text in row and split
                              var array_labels_table = $(a).children().eq(3).text().split('|');
                              //iterate through all the labels
                              for (let index = 0; index < array_labels_table.length; index++) {
                                if(checked_labels.includes(array_labels_table[index].trim())){
                                  founded = true
                                  //back to the start? Needs testing
                                  break
                                }
                              }

                              if(founded == false){
                                //add snps to delete in next fors loop
                                snps_del_list.push($(a).children().eq(0).text())
                                table_reg.rows(a).remove();
                                snp_exist = true
                              }
                              founded = false
                            }
                          });
                        
                        for(j=0;j<snps_del_list.length;j++){
                      
                          table_reg.rows().nodes().each(function(a,b) {
                            //check if row had the tissue chosen by user
                            if($(a).children().eq(0).text() == snps_del_list[j]){
                              //add snps to delete in next fors loop
                              table_reg.rows(a).remove();
                              snp_exist = true
                            }
                          });
                        }
                        //new for to delete snps in the array
                        table_reg.rows().invalidate();
                        table_reg.draw();
                        //delete from tabel step 1
                        for(j=0;j<snps_del_list.length;j++){
                        
                          table_snp.rows().nodes().each(function(a,b) {
                            if($(a).children().eq(0).text() == snps_del_list[j].trimLeft()){
                              table_snp.rows(a).remove();
                              snp_exist = true
                            }
                          });
                        }
                        table_snp.rows().invalidate();
                        table_snp.draw();
                        
                        //delete all labels from checkd labels
                        checked_labels = [];
                      });
                    });
                  </script>

                <div id="step-3">
                  <!-- step 3 -->
                  <div class="col-md-12 col-sm-12 col-xs-12">
                      
                      <div class="x_title">
                        <h2 class="StepTitle"> Step 3 <small> Generate Sequences </small></h2>
                        <div class="clearfix"></div>
                      </div>
                      <div class="x_content">
                        <p class="text-muted font-13 m-b-30">
                          Your generated sequences will show up here. click on the generate button
                        </p>
                        <!-- class="control-label col-md-3 col-sm-3 col-xs-12" -->
                        <!-- class="col-md-9 col-sm-9 col-xs-12" -->
                        <label  style="display: inline-flex">Select Matrix</label>
                        <div  style="display: inline-flex">
                          
                          <select class="form-control" id="tfs">
                            <option>JASPAR_CNE_2008</option>
                            <option>JASPAR_CORE_2014_vertebrates</option>
                            <option>JASPAR_CORE_2014</option>
                            <option>JASPAR_CORE_2016_vertebrates</option>
                            <option>JASPAR_CORE_2016</option>
                            <option>JASPAR_CORE_REDUNDANT_2014_vertebrates</option>
                            <option>JASPAR_CORE_REDUNDANT_2014</option>
                            <option>JASPAR_CORE_REDUNDANT_2016_vertebrates</option>
                            <option>JASPAR_FAM_2008</option>
                            <option>JASPAR_PHYLOFACTS_2008</option>
                            <option>JASPAR_POLII_2008</option>
                            <option>JASPAR_SPLICE_2008</option>
                            <option>JASPAR2018_CNE</option>
                            <option>JASPAR2018_CORE_vertebrates_non-redundant</option>
                            <option>JASPAR2018_CORE_vertebrates_redundant</option>
                            <option>JASPAR2018_FAM</option>
                            <option>JASPAR2018_PHYLOFACTS</option>
                            <option>JASPAR2018_POLII</option>
                            <option>JASPAR2018_SPLICE</option>
                          </select>
                          <!-- class="col-md-6 col-sm-6 col-xs-12" -->
                          <p style="margin-right: 15px;margin-left: 15px" > or </p>
                          <form class="form_inline" enctype="multipart/form-data" action="/upload_matrix" method="POST" id="form_file_matrix">
                            <div class="input-group">
                              <div class="custom-file" style="display: inline-flex">
                                <input type="file" class="custom-file-input-matrix" id="inputGroupFile02" name="file_matrix" aria-describedby="inputGroupFileAddon02"></input>
                                <button type="submit" class="btn btn-success btn-xs submit_matrix" id="submit_matrix"><i class="fa fa-upload"></i> Upload </button>
                              </div>
                              
                            </div>
                            
                          </form>
                         
                        </div>

                      </div>
                      <form style="display: inline-flex;margin-bottom: 20px;">
                        <label for="p-value" style="margin-right:10px;text-align: center;">P-value</label>
                            <select name="p-value" id="p-value" style="margin-right: 20px;">
                              <option>1</option>
                              <option>0.1</option>
                              <option>0.01</option>
                              <option>0.001</option>
                              <option selected="selected">1E-4</option>
                              <option>1E-5</option>
                              <option>1E-6</option>
                              <option>1E-7</option>
                              <option>1E-8</option>
                              <option>1E-9</option>
                            </select>
                            <div class="checkbox-q" style="display: inline-flex;">
                              <label for="q-value" style="margin-right:10px;">Use q-value</label>
                                  <input id="q-value" type="checkbox" value="1" id="q-check" class="flat" style="position: absolute; opacity: 0;">
                            </div>
                      </form>
                      <form>
                        <a href="#" class="btn btn-success btn-xs generate" onclick="$('.load3').show();"><i class="fa fa-play"></i> Generate</a>
                        <div class="load3" style="display:inline-block"> <i class="fa fa-cog fa-spin fa-5x fa-fw"style="font-size: 25px;"></i> </div>
                        <span class="load3">Processing...</span>
                      </form>
                      <p id="sequences" style="font-family: 'Courier New', Courier, monospace"></p>
                      
                  </div>

                </div>
                <!-- <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script> -->
                <!-- <script src="dataTables.rowsGroup.js"></script> -->
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                <script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
                <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
                <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
                <!--hide loading image-->
                <script>
                  $(document).ready(function() {
                    $('.load3').hide();
                  });
                </script>
                <script>
                var uploaded = 0;
                //javascript for upload matrix
                $(function() {
                          $('#form_file_matrix').on("submit", function() {
                            // event.preventDefault()
                            //send file excel file
                            var formData = new FormData(this);

                            if ($('#inputGroupFile02').val().trim() == false){
                              alert("Insert .meme file")
                              return false;
                            }
                            $.ajax({

                              url: '/home/upload_matrix',
                              type: 'POST',
                              // dataType: 'json',
                              data: formData,
                              success:function(response) {
                                //hide gif after success
                                alert("File uploaded")
                                console.log("Success form")
                                console.log(response)
                                uploaded = 1
                                $('#tfs').attr("disabled", 'disabled');
                                
                              },error:function(){
                                  alert("Error")
                                },
                              cache: false,
                              contentType: false,
                              processData: false
                              });
                              return false;
                            });
                          });
                </script>
                <script type="text/javascript">
                  //create global variable
                  var allele_dict;
                  //Script for generate button
                  $(function() {
                    //Getting information from snp_datatable first step
                    //When run button is clicked in the second step
                    $('.btn.btn-success.btn-xs.generate').bind('click', function() {
                      //important method so that ajax doesn't refresh the page
                      event.preventDefault()
                      //empty HTML element to put sequences in
                      var element;
                      element = document.getElementById("sequences");
                      if (element) {
                        element.innerHTML = "";
                      }
                      ////get information from table in step 1
                      
                      //instantiate table
                      var table = $('#datatable-buttons').DataTable();
                      //get size of all rows data
                      var rows2 = table.rows().data().length;
                      //empty row list information
                      if (rows2 == 0){
                        alert("Insert snp first");
                        //hide load button
                        $('.load3').hide();
                        return false;
                      }
                      var row_list = []
                      //get data from all rows
                      for(i=0;i<rows2;i++){
                        row_list.push(table.rows().data()[i])
                      };
                      var checkBox = $(':checkbox:checked');
                      var id_user = '{{ current_user.id }}';
                      var q_check = false;
                      console.log(checkBox)
                      for (let index = 0; index <$(':checkbox:checked').length; index++) {
                          var element = $(':checkbox:checked')[index].value;
                          if ($(':checkbox:checked')[index].id ==  "q-value"){
                            q_check = true
                          }
                      }
                      $.ajax({
                        url: '/home/gen_sequence',
                        type: 'POST',
                        dataType: 'json',
                        data: { snp_list: JSON.stringify(row_list),
                                tf:$('#tfs').val(),
                                p_value:$('#p-value').val(),
                                q_value:q_check,
                                upload:uploaded,
                                user_id: id_user,
                                user_email : '{{current_user.email}}'
                              },
                        // async: false,
                        success:function(response) {
                          //hide load button
                          $('.load3').hide();
                          //reset upload
                          uploaded = 0
                          //reset disable
                          $('#tfs').removeAttr('disabled');
                          //some debbugging
                          alert("DONE")
                          //insert alleles dictionary in variable
                          allele_dict = response[1]
                          //insert text into 'p' element
                          for(i=0;i<response[0][0].length;i++){
                            $('#sequences').append( document.createTextNode( response[0][0][i]) );
                            $('#sequences').append( document.createElement( "br") );
                            console.log(response[0][0][i])
                          }
                        }
                      });
                    });
                  });

                </script>

                <div id="step-4">
                  <!-- step 4 -->
                  <div class="col-md-12 col-sm-12 col-xs-12">
                      
                      <div class="x_title">
                        <h2 class="StepTitle"> Step 4 <small>Differential Transcription Factors </small></h2>
                        <!-- <i class="fa fa-question-circle fa-2x" data-container="body"data-toggle="tooltip" data-placement="top" title="Tooltip on top"></i> -->
                        <div class="clearfix"></div>
                      </div>
                      <div class="x_content">
                        <p class="text-muted font-13 m-b-30">
                          Here is showing up all the differential transcription factors
                        </p>
                        <div>
                            <a href="#" class="btn btn-success btn-xs dif-tf" onclick="$('.load4').show();"><i class="fa fa-play"></i> Run </a>
                            <div class="load4" style="display:inline-block"> <i class="fa fa-cog fa-spin fa-5x fa-fw"style="font-size: 25px;"></i> </div>
                            <span class="load4">Processing...</span>
                          </div>
                          <table id="datatable-buttons-ft" class="table table-striped table-bordered">
                            <thead>
                              <tr>
                                <th>Motif ID</th>
                                <th>Motif Alt ID</th>
                                <th>Sequence Name</th>
                                <th>Strand</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>p-value</th>
                                <th>q-value</th>
                                <th>Matched Sequence</th>
                              </tr>
                            </thead>
                            <tbody id="t-body">
                              <!--Style Datatables-buttons-ft to add margin-->
                            <style>
                                #datatable-buttons-ft_wrapper {
                                  margin-top: 10px;
                                }
                              </style>
                            </tbody>
                          </table>
                        </div>
                      </div>
                </div>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                <script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
                <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
                <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
                <script>
                  $(document).ready(function() {
                    $('.load4').hide();
                  });
                </script>
                <script type="text/javascript">
                $(document).ready(function() {
                    $('#datatable-buttons-ft').DataTable( {
                      dom: 'Bfrtip',
                      buttons: {
                        buttons: [
                          { extend: 'copy', className: 'btn-sm' },
                          { extend: 'csv', className: 'btn-sm' },
                          { extend: 'print', className: 'btn-sm' }
                        ]
                      }
                      } );
                  } );
                  //Script for run button in step 4
                  //Show differential transcription factor
                  $(function() {
                    //Getting information from snp_datatable first step
                    //When run button is clicked in the second step
                    $('.btn.btn-success.btn-xs.dif-tf').bind('click', function() {

                      //important method so that the ajax doesn't refresh the page
                      event.preventDefault()
                      var tab_tf = $('#datatable-buttons-ft').DataTable();
                      tab_tf.clear().draw();
                      //if user clicks on button before clicking on step 3 button
                      if( allele_dict== undefined) {
                        alert('Click generate button on step 3');
                        $('.load4').hide();
                        return false;
                      }
                      var user_id = '{{ current_user.id }}'
                      $.ajax({
                        url: '/home/dif_tf',
                        type: 'POST',
                        dataType: 'json',
                        data: { fimo_tsv: "fimo_out/fimo.tsv",
                                al_dict: JSON.stringify(allele_dict),
                                user_id : user_id,
                                user_email : '{{current_user.email}}',
                                },
                        success:function(response) {
                          alert('DONE')
                          $('.load4').hide();
                          if (response.length == 0){
                            alert("Differential transcription factors not found")
                          }
                          //insert into table
                          //declare datatable
                          var t = $('#datatable-buttons-ft').DataTable();
                          //iterate through response to add rows in the table
                          for(i=0;i<response.length;i++){
                            t.row.add( [
                              response[i]['motif_id'],
                              response[i]['motif_alt_id'],
                              response[i]['sequence_name'],
                              response[i]['strand'],
                              response[i]['start'],
                              response[i]['stop'],
                              response[i]['p-value'],
                              response[i]['q-value'],
                              response[i]['matched_sequence'],
                            ] );
                          }; 
                          t.draw(); 
                        }
                      });
                    });
                    
                  });
                
                </script>
                <div id="step-5">
                  <!-- step 5 -->
                  <div class="col-md-12 col-sm-12 col-xs-12">
                      
                      <div class="x_title">
                        <h2 class="StepTitle"> Step 5 <small>Enhancer Promoter Interaction </small></h2>
                        <div class="clearfix"></div>
                      </div>
                      <div class="x_content">
                        <p class="text-muted font-13 m-b-30">
                          This part shows enhancer and promoter interaction pairs of snps inside enhancer region. See <a href="/home/index2" target="_blank">ID Catalogue</a> to insert in field.. To enter more than one tissue, write | between them.
                        </p>
                        <div>
                          <form class="form-inline">
                              <input type="text" name="tissue_field_epi" id="tissue_field_epi" class="form-control"></input>
                              <a href="#" class="btn btn-success btn-xs epi" onclick="$('.load5').show();"><i class="fa fa-play"></i> Run </a>
                              <div class="load5" style="display:inline-block"> <i class="fa fa-cog fa-spin fa-5x fa-fw"style="font-size: 25px;"></i> </div>
                              <span class="load5">Processing...</span>
                          </form>

                        </div>
                        <table id="datatable-buttons-epi" class="table table-striped table-bordered">
                          <thead>
                            <tr>
                              <th>SNP</th>
                              <th>Location</th>
                              <th>Gene ID</th>
                              <th>Gene</th>
                              <th>Gene Location</th>
                              <th>Score</th>
                              <th>Tissue</th>
                              <th>File Type</th>
                            </tr>
                          </thead>

                          <tbody id="t-body">
                            
                          </tbody>
                            <!--Style Datatables-buttons-epi to add margin-->
                            <style>
                                #datatable-buttons-epi_wrapper {
                                  margin-top: 10px;
                                }
                              </style>
                        </table>
                      </div>
                          
                    </div>
                  </div>
                  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                  <script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
                  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
                  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
                  <script>
                    $(document).ready(function() {
                      $('.load5').hide();
                    });
                  </script>
                  <script type="text/javascript">
                    $(document).ready(function() {
                      $('#datatable-buttons-epi').DataTable( {
                        dom: 'Bfrtip',
                        buttons: {
                        buttons: [
                          { extend: 'copy', className: 'btn-sm' },
                          { extend: 'csv', className: 'btn-sm' },
                          { extend: 'print', className: 'btn-sm' }
                        ]
                        }
                      } );
                    } );
                        $(function() {
                          //Getting information from snp_datatable first step
                          //When run button is clicked in the second step
                          $('.btn.btn-success.btn-xs.epi').bind('click', function() {
                            //important method so that the ajax doesn't refresh the page
                            event.preventDefault()
                            var tab_epi = $('#datatable-buttons-epi').DataTable();
                            tab_epi.clear().draw();
                            ////get information from table in step 1
                            //instantiate table
                            var table = $('#datatable-buttons').DataTable();
                            //get size of all rows data
                            var rows_size = table.rows().data().length;
                            //empty row list information
                            var row_list = []
                            //get data from all rows
                            for(i=0;i<rows_size;i++){
                              row_list.push(table.rows().data()[i])
                            };
                            console.log(row_list);
                            console.log(row_list[0]);
                            var tissue = $('#tissue_field_epi').val();
                            var user_id = '{{ current_user.id }}';
                          $.ajax({
                            url: '/home/epi',
                            type: 'POST',
                            dataType: 'json',
                            data: { snp_list: JSON.stringify(row_list), 
                                    tissue_field_epi: tissue,
                                    user_id: user_id,
                                    user_email : '{{current_user.email}}',
                            },
                            async: false,
                            success:function(response) {
                              $('.load5').hide();
                              //some debbugging
                              if (response.length == 0){
                                alert("Interaction Not Found")
                              }
                              console.log("LOG: " + response['SNP'])
                              console.log("SIZE: " + response.length)
                              //declare datatable
                              var t = $('#datatable-buttons-epi').DataTable();
                              //iterate through response to add rows in the table
                              for(i=0;i<response.length;i++){
                                t.row.add( [
                                  response[i]['SNP'],
                                  response[i]['Location'],
                                  response[i]['Gene ID'],
                                  response[i]['Gene'],
                                  response[i]['Gene Location'],
                                  response[i]['Score'],
                                  response[i]['Tissue'],
                                  response[i]['File_Type'],
                                ] )
                              };
                              t.draw();  
                            },error: function(){
                              alert("Tissue do not exist")
                            }

                          });
                          });
                        });
                        </script>
                  </div>
                </div>

              </div>
              <!-- End SmartWizard Content -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block javascripts %}
  {{ super()}}
  <!-- Table methods -->
  <!-- Rows Group -->
  <!-- <script src="//cdn.rawgit.com/ashl1/datatables-rowsgroup/v1.0.0/dataTables.rowsGroup.js"></script> -->
  <!-- tables.js -->
  <script src=""></script>
  <!-- Chart.js -->
  <script src="{{ url_for('static', filename='vendors/Chart.js/dist/Chart.min.js') }}"></script>
  <!-- gauge.js -->
  <script src="{{ url_for('static', filename='vendors/gauge.js/dist/gauge.min.js') }}"></script>
  <!-- Skycons -->
  <script src="{{ url_for('static', filename='vendors/skycons/skycons.js') }}"></script>
  <!-- Flot -->
  <script src="{{ url_for('static', filename='vendors/Flot/jquery.flot.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/Flot/jquery.flot.pie.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/Flot/jquery.flot.time.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/Flot/jquery.flot.stack.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/Flot/jquery.flot.resize.js') }}"></script>
  <!-- Flot plugins -->
  <script src="{{ url_for('static', filename='vendors/flot.orderbars/js/jquery.flot.orderBars.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/flot-spline/js/jquery.flot.spline.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/flot.curvedlines/curvedLines.js') }}"></script>
  <!-- DateJS -->
  <script src="{{ url_for('static', filename='vendors/DateJS/build/date.js') }}"></script>
  <!-- JQVMap -->
  <script src="{{ url_for('static', filename='vendors/jqvmap/dist/jquery.vmap.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/jqvmap/dist/maps/jquery.vmap.world.js') }}"></script>
  <script src="{{ url_for('static', filename='vendors/jqvmap/examples/js/jquery.vmap.sampledata.js') }}"></script>
  <!-- jQuery Smart Wizard -->
  <script src="{{ url_for('static', filename='vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js') }}"></script>
   <!-- Datatables -->
   <script src="{{ url_for('static', filename='vendors/datatables.net/js/jquery.dataTables.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-bs/js/dataTables.bootstrap.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-buttons/js/dataTables.buttons.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-buttons/js/buttons.flash.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-buttons/js/buttons.html5.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-buttons/js/buttons.print.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-keytable/js/dataTables.keyTable.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-responsive/js/dataTables.responsive.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/datatables.net-scroller/js/dataTables.scroller.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/jszip/dist/jszip.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/pdfmake/build/pdfmake.min.js') }}"></script>
   <script src="{{ url_for('static', filename='vendors/pdfmake/build/vfs_fonts.js') }}"></script>
{% endblock javascripts %}
